FROM 448613307115.dkr.ecr.eu-west-1.amazonaws.com/jvm-oracle:latest

ENV SERVER_PORT="8080" \
    MESSAGING_BOOTSTRAP_CONTENT_CHANGES_ENABLED="false" \
    MESSAGING_BOOTSTRAP_CQL_CONTENT_CHANGES_ENABLED="false" \
    MESSAGING_BOOTSTRAP_TOPICS_CHANGES_ENABLED="false" \
    MESSAGING_BOOTSTRAP_SCHEDULE_CHANGES_ENABLED="false" \
    MESSAGING_BOOTSTRAP_EVENT_CHANGES_ENABLED="false" \
    MESSAGING_BOOTSTRAP_ORGANISATION_CHANGES_ENABLED="false" \
    MESSAGING_DEER_EQUIVALENT_CONTENT_CONTENT_CHANGES_ENABLED="false" \
    MESSAGING_DEER_EQUIVALENT_CONTENT_GRAPH_CHANGES_ENABLED="false" \
    MESSAGING_DEER_EQUIVALENT_SCHEDULE_CONTENT_CHANGES_ENABLED="false" \
    MESSAGING_DEER_EQUIVALENT_SCHEDULE_GRAPH_CHANGES_ENABLED="false" \
    MESSAGING_DEER_EQUIVALENT_SCHEDULE_SCHEDULE_CHANGES_ENABLED="false" \
    MESSAGING_DEER_EQUIVALENCE_CONTENT_GRAPH_CHANGES_ENABLED="false" \
    MESSAGING_DEER_CONTENT_INDEXER_ENABLED="false" \
    MESSAGING_DEER_TOPIC_INDEXER_ENABLED="false" \
    MESSAGING_DEER_CONTENT_NEO4J_CONTENT_CHANGES_ENABLED="false" \
    MESSAGING_DEER_CONTENT_NEO4J_GRAPH_CHANGES_ENABLED="false" \
    LOG4J_CONFIGURATION="file:////usr/local/jetty/log4j.properties" \
    NIMROD_LOG_LEVEL="INFO" \
    ROOT_LOG_LEVEL="INFO" \
    JVM_MEMORY="6G" \
    DEBUG_AND_REMOTE_OPTS="" \
    JVM_OPTS="-XX:+UseG1GC \
      -XX:MaxGCPauseMillis=150 \
      -XX:CMSInitiatingOccupancyFraction=60 \
      -XX:+ExitOnOutOfMemoryError"

COPY atlas-processing/target/atlas-processing.war /usr/local/jetty/atlas-processing.war
COPY atlas-processing/log4j.properties /usr/local/jetty/log4j.properties

WORKDIR /usr/local/jetty

CMD java \
    -Djetty.home="$JETTY_HOME" \
    -Dsun.net.inetaddr.ttl="$SUN_NET_INETADDR_TTL" \
    -DMBST_PLATFORM="$MBST_PLATFORM" \
    -Dc4.apikey="$C4_APIKEY" \
    -Dc4.keystore.password="$C4_KEYSTORE_PASSWORD" \
    -Dc4.lakeviewavailability.key="$C4_LAKEVIEWAVAILABILITY_KEY" \
    -Dcassandra.clientThreads="$CASSANDRA_CLIENTTHREADS" \
    -Dcassandra.cluster="$CASSANDRA_CLUSTER" \
    -Dcassandra.datastax.timeouts.connections="$CASSANDRA_DATASTAX_TIMEOUTS_CONNECTIONS" \
    -Dcassandra.datastax.timeouts.read="$CASSANDRA_DATASTAX_TIMEOUTS_READ" \
    -Dcassandra.keyspace="$CASSANDRA_KEYSPACE" \
    -Dcassandra.seeds="$CASSANDRA_SEEDS" \
    -Delasticsearch.cluster="$ELASTICSEARCH_CLUSTER" \
    -Delasticsearch.index="$ELASTICSEARCH_INDEX" \
    -Delasticsearch.requestTimeout="$ELASTICSEARCH_REQUESTTIMEOUT" \
    -Delasticsearch.seeds="$ELASTICSEARCH_SEEDS" \
    -Dequiv.update.producer.system="$EQUIV_UPDATE_PRODUCER_SYSTEM" \
    -Dhttp.nonProxyHosts="$HTTP_NONPROXYHOSTS" \
    -Dhttp.proxyHost="$HTTP_PROXYHOST" \
    -Dhttp.proxyPort="$HTTP_PROXYPORT" \
    -Dhttps.proxyHost="$HTTPS_PROXYHOST" \
    -Dhttps.proxyPort="$HTTPS_PROXYPORT" \
    -Dlakeview.upload.account="$LAKEVIEW_UPLOAD_ACCOUNT" \
    -Dlakeview.upload.key="$LAKEVIEW_UPLOAD_KEY" \
    -Dlovefilm.oauth.api.key="$LOVEFILM_OAUTH_API_KEY" \
    -Dlovefilm.oauth.api.secret="$LOVEFILM_OAUTH_API_SECRET" \
    -Dmessaging.bootstrap.system="$MESSAGING_BOOTSTRAP_SYSTEM" \
    -Dmessaging.bootstrap.content.changes.consumers="$MESSAGING_BOOTSTRAP_CONTENT_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.content.changes.enabled="$MESSAGING_BOOTSTRAP_CONTENT_CHANGES_ENABLED" \
    -Dmessaging.bootstrap.cql-content.changes.consumers="$MESSAGING_BOOTSTRAP_CQL_CONTENT_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.cql-content.changes.enabled="$MESSAGING_BOOTSTRAP_CQL_CONTENT_CHANGES_ENABLED" \
    -Dmessaging.bootstrap.topics.changes.consumers="$MESSAGING_BOOTSTRAP_TOPICS_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.topics.changes.enabled="$MESSAGING_BOOTSTRAP_TOPICS_CHANGES_ENABLED" \
    -Dmessaging.bootstrap.schedule.changes.consumers="$MESSAGING_BOOTSTRAP_SCHEDULE_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.schedule.changes.enabled="$MESSAGING_BOOTSTRAP_SCHEDULE_CHANGES_ENABLED" \
    -Dmessaging.bootstrap.event.changes.consumers="$MESSAGING_BOOTSTRAP_EVENT_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.event.changes.enabled="$MESSAGING_BOOTSTRAP_EVENT_CHANGES_ENABLED" \
    -Dmessaging.bootstrap.organisation.changes.consumers="$MESSAGING_BOOTSTRAP_ORGANISATION_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.organisation.changes.enabled="$MESSAGING_BOOTSTRAP_ORGANISATION_CHANGES_ENABLED" \
    -Dmessaging.system="$MESSAGING_SYSTEM" \
    -Dmessaging.deer.equivalent.content.content.changes.consumers="$MESSAGING_DEER_EQUIVALENT_CONTENT_CONTENT_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.content.content.changes.enabled="$MESSAGING_DEER_EQUIVALENT_CONTENT_CONTENT_CHANGES_ENABLED" \
    -Dmessaging.deer.equivalent.content.graph.changes.consumers="$MESSAGING_DEER_EQUIVALENT_CONTENT_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.content.graph.changes.enabled="$MESSAGING_DEER_EQUIVALENT_CONTENT_GRAPH_CHANGES_ENABLED" \
    -Dmessaging.deer.equivalent.schedule.content.changes.consumers="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_CONTENT_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.schedule.content.changes.enabled="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_CONTENT_CHANGES_ENABLED" \
    -Dmessaging.deer.equivalent.schedule.graph.changes.consumers="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.schedule.graph.changes.enabled="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_GRAPH_CHANGES_ENABLED" \
    -Dmessaging.deer.equivalent.schedule.schedule.changes.consumers="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_SCHEDULE_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.schedule.schedule.changes.enabled="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_SCHEDULE_CHANGES_ENABLED" \
    -Dmessaging.deer.equivalence.content.graph.changes.consumers="$MESSAGING_DEER_EQUIVALENCE_CONTENT_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalence.content.graph.changes.enabled="$MESSAGING_DEER_EQUIVALENCE_CONTENT_GRAPH_CHANGES_ENABLED" \
    -Dmessaging.deer.content.indexer.consumers="$MESSAGING_DEER_CONTENT_INDEXER_CONSUMERS" \
    -Dmessaging.deer.content.indexer.graph.changes.consumers="$MESSAGING_DEER_CONTENT_INDEXER_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.content.indexer.enabled="$MESSAGING_DEER_CONTENT_INDEXER_ENABLED" \
    -Dmessaging.deer.topic.indexer.consumers="$MESSAGING_DEER_TOPIC_INDEXER_CONSUMERS" \
    -Dmessaging.deer.topic.indexer.enabled="$MESSAGING_DEER_TOPIC_INDEXER_ENABLED" \
    -Dmessaging.deer.content.neo4j.content.changes.consumers="$MESSAGING_DEER_CONTENT_NEO4J_CONTENT_CHANGES_CONSUMERS" \
    -Dmessaging.deer.content.neo4j.content.changes.enabled="$MESSAGING_DEER_CONTENT_NEO4J_CONTENT_CHANGES_ENABLED" \
    -Dmessaging.deer.content.neo4j.graph.changes.consumers="$MESSAGING_DEER_CONTENT_NEO4J_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.content.neo4j.graph.changes.enabled="$MESSAGING_DEER_CONTENT_NEO4J_GRAPH_CHANGES_ENABLED" \
    -Dmessaging.broker.url="$MESSAGING_BROKER_URL" \
    -Dmessaging.zookeeper="$MESSAGING_ZOOKEEPER" \
    -Dmetrics.environment.prefix="$METRICS_ENVIRONMENT_PREFIX" \
    -Dmetrics.graphite.host="$METRICS_GRAPHITE_HOST" \
    -Dmetrics.graphite.port="$METRICS_GRAPHITE_PORT" \
    -Dmongo.read.host="$MONGO_READ_HOST" \
    -Dmongo.read.name="$MONGO_READ_NAME" \
    -Dmongo.write.host="$MONGO_WRITE_HOST" \
    -Dmongo.write.name="$MONGO_WRITE_NAME" \
    -Dneo4j.host="$NEO4J_HOST" \
    -Dneo4j.maxIdleSessions="$NEO4J_MAXIDLESESSIONS" \
    -Dneo4j.port="$NEO4J_PORT" \
    -Dpa.ftp.password="$PA_FTP_PASSWORD" \
    -Dpa.ftp.username="$PA_FTP_USERNAME" \
    -Dprocessing.config="$PROCESSING_CONFIG" \
    -Dredux.password="$REDUX_PASSWORD" \
    -Dredux.username="$REDUX_USERNAME" \
    -Dreporting.columbus-telescope.host="$REPORTING_COLUMBUS_TELESCOPE_HOST" \
    -Drp.password.unique="$RP_PASSWORD_UNIQUE" \
    -Ds3.access="$S3_ACCESS" \
    -Ds3.secret="$S3_SECRET" \
    -Dschedule.v2.enabled="$SCHEDULE_V2_ENABLED" \
    -Dserver.port="$SERVER_PORT" \
    -Dtwitter.auth.consumerKey="$TWITTER_AUTH_CONSUMERKEY" \
    -Dtwitter.auth.consumerSecret="$TWITTER_AUTH_CONSUMERSECRET" \
    -Dlog4j.configuration="$LOG4J_CONFIGURATION" \
    -Dnimrod.log.level="$NIMROD_LOG_LEVEL" \
    -Droot.log.level="$ROOT_LOG_LEVEL" \
    -Xmx$JVM_MEMORY \
    -Xms$JVM_MEMORY \
    $DEBUG_AND_REMOTE_OPTS \
    $JVM_OPTS \
    -jar atlas-processing.war
