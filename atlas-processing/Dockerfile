FROM 448613307115.dkr.ecr.us-east-1.amazonaws.com/jvm-oracle8:latest

ENV JETTY_HOME="/usr/local/jetties/atlas-processing" \
    SUN_NET_INETADDR_TTL="60" \
    MBST_PLATFORM="stage" \
    C4_APIKEY="sxwmsq9k9mtkdh9ff6vxuyjs" \
    CASSANDRA_CLIENTTHREADS="50" \
    CASSANDRA_CLUSTER="Stage" \
    CASSANDRA_DATASTAX_TIMEOUTS_CONNECTIONS="11000" \
    CASSANDRA_DATASTAX_TIMEOUTS_READ="11000" \
    CASSANDRA_KEYSPACE="atlas_deer_stage" \
    CASSANDRA_SEEDS="cassandra1.stage.atlas.mbst.tv,cassandra2.stage.atlas.mbst.tv" \
    ELASTICSEARCH_CLUSTER="atlas_deer_stage" \
    ELASTICSEARCH_INDEX="content" \
    ELASTICSEARCH_REQUESTTIMEOUT="60000" \
    ELASTICSEARCH_SEEDS="node1.search.stage.deer.atlas.mbst.tv" \
    EQUIV_UPDATE_PRODUCER_SYSTEM="AtlasOwlProd" \
    LAKEVIEW_UPLOAD_ACCOUNT="testpartfeed14" \
    LOVEFILM_OAUTH_API_KEY="ubdxxqxe4nrnbdae8wt92pqe" \
    MESSAGING_BOOTSTRAP_CONTENT_CHANGES_CONSUMERS="10" \
    MESSAGING_BOOTSTRAP_EVENT_CHANGES_CONSUMERS="1" \
    MESSAGING_BOOTSTRAP_ORGANISATION_CHANGES_CONSUMERS="1" \
    MESSAGING_BOOTSTRAP_SCHEDULE_CHANGES_CONSUMERS="5" \
    MESSAGING_BOOTSTRAP_SYSTEM="AtlasOwlProd" \
    MESSAGING_BOOTSTRAP_TOPICS_CHANGES_CONSUMERS="2" \
    MESSAGING_BROKER_URL="node1.kafka.mbst.tv:9092,node2.kafka.mbst.tv:9092,node3.kafka.mbst.tv:9092,node4.kafka.mbst.tv:9092" \
    MESSAGING_DEER_CONTENT_INDEXER_CONSUMERS="10" \
    MESSAGING_DEER_CONTENT_INDEXER_GRAPH_CHANGES_CONSUMERS="10" \
    MESSAGING_DEER_EQUIVALENCE_CONTENT_GRAPH_CHANGES_CONSUMERS="10" \
    MESSAGING_DEER_EQUIVALENT_CONTENT_CONTENT_CHANGES_CONSUMERS="10" \
    MESSAGING_DEER_EQUIVALENT_CONTENT_GRAPH_CHANGES_CONSUMERS="10" \
    MESSAGING_DEER_EQUIVALENT_SCHEDULE_CONTENT_CHANGES_CONSUMERS="10" \
    MESSAGING_DEER_EQUIVALENT_SCHEDULE_CONTENT_CHANGES_ENABLED="true" \
    MESSAGING_DEER_EQUIVALENT_SCHEDULE_GRAPH_CHANGES_CONSUMERS="10" \
    MESSAGING_DEER_EQUIVALENT_SCHEDULE_SCHEDULE_CHANGES_CONSUMERS="10" \
    MESSAGING_DEER_TOPIC_INDEXER_CONSUMERS="1" \
    MESSAGING_SYSTEM="AtlasDeerStage" \
    MESSAGING_ZOOKEEPER="node1.kafka.mbst.tv:2181,node2.kafka.mbst.tv:2181,node3.kafka.mbst.tv:2181" \
    METRICS_ENVIRONMENT_PREFIX="processing.stage." \
    METRICS_GRAPHITE_HOST="graphite.mbst.tv" \
    METRICS_GRAPHITE_PORT="2003" \
    MONGO_READ_HOST="db1.owl.atlas.mbst.tv,db3.owl.atlas.mbst.tv" \
    MONGO_READ_NAME="atlas-split" \
    MONGO_WRITE_HOST="db1.stage.atlas.mbst.tv" \
    MONGO_WRITE_NAME="atlas-split" \
    NOTIFICATIONS_EMAIL_FROM="atlas-admin@metabroadcast.com" \
    NOTIFICATIONS_EMAIL_FROMFRIENDLYNAME="Atlas" \
    NOTIFICATIONS_EMAIL_HOST="smtp.gmail.com" \
    NOTIFICATIONS_EMAIL_TO="atlas@metabroadcast.com" \
    NOTIFICATIONS_EMAIL_USERNAME="atlas-admin@metabroadcast.com" \
    PA_FTP_USERNAME="metabroadcast" \
    PROCESSING_CONFIG="true" \
    S3_ACCESS="AKIAJRJF74PCXOBZNUTQ" \
    SCHEDULE_V2_ENABLED="true" \
    SERVER_PORT="8080" \
    TWITTER_AUTH_CONSUMERKEY="BvVeHDlcMPxyKzGbM6JYw" \
    JSSE_ENABLESNIEXTENSION="false" \
    HTTP_NONPROXYHOSTS="localhost|*.mbst.tv|*.metabroadcast.com|*.atlasapi.org" \
    HTTP_PROXYHOST="lb.proxy.mbst.tv" \
    HTTP_PROXYPORT="3128" \
    HTTPS_PROXYHOST="lb.proxy.mbst.tv" \
    HTTPS_PROXYPORT="3128" \
    LOG4J_CONFIGURATION="file:////usr/local/jetties/atlas-processing/work/log4j.properties" \
    NIMROD_LOG_LEVEL="INFO" \
    ROOT_LOG_LEVEL="INFO" \
    JMX_MEMORY="2G" \
    JMX_OPTS="-XX:+UseG1GC" -XX:MaxGCPauseMillis="2000"

COPY atlas-processing/target/atlas-processing.war /usr/local/jetties/atlas-processing/lib/atlas-processing.war
COPY atlas-processing/log4j.properties /usr/local/jetties/atlas-processing/work/log4j.properties

WORKDIR /usr/local/jetties/atlas-processing

CMD java \
    -Djetty.home="$JETTY_HOME" \
    -Dsun.net.inetaddr.ttl="$SUN_NET_INETADDR_TTL" \
    -DMBST_PLATFORM="$MBST_PLATFORM" \
    -Dc4.apikey="$C4_APIKEY" \
    -Dc4.keystore.password="$C4_KEYSTORE_PASSWORD" \
    -Dc4.lakeviewavailability.key="$C4_LAKEVIEWAVAILABILITY_KEY" \
    -Dcassandra.clientThreads="$CASSANDRA_CLIENTTHREADS" \
    -Dcassandra.cluster="$CASSANDRA_CLUSTER" \
    -Dcassandra.datastax.timeouts.connections="$CASSANDRA_DATASTAX_TIMEOUTS_CONNECTIONS" \
    -Dcassandra.datastax.timeouts.read="$CASSANDRA_DATASTAX_TIMEOUTS_READ" \
    -Dcassandra.keyspace="$CASSANDRA_KEYSPACE" \
    -Dcassandra.seeds="$CASSANDRA_SEEDS" \
    -Delasticsearch.cluster="$ELASTICSEARCH_CLUSTER" \
    -Delasticsearch.index="$ELASTICSEARCH_INDEX" \
    -Delasticsearch.requestTimeout="$ELASTICSEARCH_REQUESTTIMEOUT" \
    -Delasticsearch.seeds="$ELASTICSEARCH_SEEDS" \
    -Dequiv.update.producer.system="$EQUIV_UPDATE_PRODUCER_SYSTEM" \
    -Dlakeview.upload.account="$LAKEVIEW_UPLOAD_ACCOUNT" \
    -Dlakeview.upload.key"$LAKEVIEW_UPLOAD_KEY" \
    -Dlovefilm.oauth.api.key="$LOVEFILM_OAUTH_API_KEY" \
    -Dlovefilm.oauth.api.secret="$LOVEFILM_OAUTH_API_SECRET" \
    -Dmessaging.bootstrap.content.changes.consumers="$MESSAGING_BOOTSTRAP_CONTENT_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.event.changes.consumers="$MESSAGING_BOOTSTRAP_EVENT_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.organisation.changes.consumers="$MESSAGING_BOOTSTRAP_ORGANISATION_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.schedule.changes.consumers="$MESSAGING_BOOTSTRAP_SCHEDULE_CHANGES_CONSUMERS" \
    -Dmessaging.bootstrap.system="$MESSAGING_BOOTSTRAP_SYSTEM" \
    -Dmessaging.bootstrap.topics.changes.consumers="$MESSAGING_BOOTSTRAP_TOPICS_CHANGES_CONSUMERS" \
    -Dmessaging.broker.url="$MESSAGING_BROKER_URL" \
    -Dmessaging.deer.content.indexer.consumers="$MESSAGING_DEER_CONTENT_INDEXER_CONSUMERS" \
    -Dmessaging.deer.content.indexer.graph.changes.consumers="$MESSAGING_DEER_CONTENT_INDEXER_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalence.content.graph.changes.consumers="$MESSAGING_DEER_EQUIVALENCE_CONTENT_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.content.content.changes.consumers="$MESSAGING_DEER_EQUIVALENT_CONTENT_CONTENT_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.content.graph.changes.consumers="$MESSAGING_DEER_EQUIVALENT_CONTENT_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.schedule.content.changes.consumers="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_CONTENT_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.schedule.content.changes.enabled="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_CONTENT_CHANGES_ENABLED" \
    -Dmessaging.deer.equivalent.schedule.graph.changes.consumers="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_GRAPH_CHANGES_CONSUMERS" \
    -Dmessaging.deer.equivalent.schedule.schedule.changes.consumers="$MESSAGING_DEER_EQUIVALENT_SCHEDULE_SCHEDULE_CHANGES_CONSUMERS" \
    -Dmessaging.deer.topic.indexer.consumers="$MESSAGING_DEER_TOPIC_INDEXER_CONSUMERS" \
    -Dmessaging.system="$MESSAGING_SYSTEM" \
    -Dmessaging.zookeeper="$MESSAGING_ZOOKEEPER" \
    -Dmetrics.environment.prefix="$METRICS_ENVIRONMENT_PREFIX" \
    -Dmetrics.graphite.host="$METRICS_GRAPHITE_HOST" \
    -Dmetrics.graphite.port="$METRICS_GRAPHITE_PORT" \
    -Dmongo.read.host="$MONGO_READ_HOST" \
    -Dmongo.read.name="$MONGO_READ_NAME" \
    -Dmongo.write.host="$MONGO_WRITE_HOST" \
    -Dmongo.write.name="$MONGO_WRITE_NAME" \
    -Dnotifications.email.from="$NOTIFICATIONS_EMAIL_FROM" \
    -Dnotifications.email.fromFriendlyName="$NOTIFICATIONS_EMAIL_FROMFRIENDLYNAME" \
    -Dnotifications.email.host="$NOTIFICATIONS_EMAIL_HOST" \
    -Dnotifications.email.to="$NOTIFICATIONS_EMAIL_TO" \
    -Dnotifications.email.username="$NOTIFICATIONS_EMAIL_USERNAME" \
    -Dpa.ftp.password="$PA_FTP_PASSWORD" \
    -Dpa.ftp.username="$PA_FTP_USERNAME" \
    -Dprocessing.config="$PROCESSING_CONFIG" \
    -Dredux.password="$REDUX_PASSWORD" \
    -Dredux.username="$REDUX_USERNAME" \
    -Drp.password.unique="$RP_PASSWORD_UNIQUE" \
    -Ds3.access="$S3_ACCESS" \
    -Ds3.secret="$S3_SECRET" \
    -Dschedule.v2.enabled="$SCHEDULE_V2_ENABLED" \
    -Dserver.port="$SERVER_PORT" \
    -Dtwitter.auth.consumerKey="$TWITTER_AUTH_CONSUMERKEY" \
    -Dtwitter.auth.consumerSecret="$TWITTER_AUTH_CONSUMERSECRET" \
    -Djsse.enableSNIExtension="$JSSE_ENABLESNIEXTENSION" \
    -Dhttp.nonProxyHosts="$HTTP_NONPROXYHOSTS" \
    -Dhttp.proxyHost="$HTTP_PROXYHOST" \
    -Dhttp.proxyPort="$HTTP_PROXYPORT" \
    -Dhttps.proxyHost="$HTTPS_PROXYHOST" \
    -Dhttps.proxyPort="$HTTPS_PROXYPORT" \
    -Dlog4j.configuration="$LOG4J_CONFIGURATION" \
    -Dnimrod.log.level="$NIMROD_LOG_LEVEL" \
    -Droot.log.level="$ROOT_LOG_LEVEL" \
    -Xmx$JMX_MEMORY \
    -Xms$JMX_MEMORY \
    $JMX_OPTS \
    -jar lib/atlas-processing.war
