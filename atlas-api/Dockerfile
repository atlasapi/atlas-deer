FROM 448613307115.dkr.ecr.eu-west-1.amazonaws.com/jvm-oracle:latest

ENV JETTY_HOME="/usr/local/jetties/atlas" \
    SUN_NET_INETADDR_TTL="60" \
    MBST_PLATFORM="stage" \
    CASSANDRA_CLIENTTHREADS="50" \
    CASSANDRA_CLUSTER="Stage" \
    CASSANDRA_CONNECTIONSPERHOST_LOCAL="2" \
    CASSANDRA_CONNECTIONSPERHOST_REMOTE="2" \
    CASSANDRA_DATASTAX_TIMEOUTS_CONNECTIONS="1000" \
    CASSANDRA_DATASTAX_TIMEOUTS_READ="11000" \
    CASSANDRA_KEYSPACE="atlas_deer_stage" \
    CASSANDRA_SEEDS="cassandra1.stage.atlas.mbst.tv,cassandra2.stage.atlas.mbst.tv,cassandra3.deer.atlas.mbst.tv" \
    ELASTICSEARCH_CLUSTER="atlas_deer_stage" \
    ELASTICSEARCH_INDEX="content" \
    ELASTICSEARCH_REQUESTTIMEOUT="60000" \
    ELASTICSEARCH_SEEDS="node1.search.stage.deer.atlas.mbst.tv" \
    GITHUB_AUTH_CONSUMERKEY="f3276a595feba4404b39" \
    GITHUB_AUTH_CONSUMERSECRET="" \
    GOOGLE_AUTH_CONSUMERKEY="725556533575-gljt51d93p1ddipoqokq5cqqp8vru2ri.apps.googleusercontent.com" \
    GOOGLE_AUTH_CONSUMERSECRET="" \
    MESSAGING_BROKER_URL="node1.kafka.mbst.tv:9092,node2.kafka.mbst.tv:9092,node3.kafka.mbst.tv:9092,node4.kafka.mbst.tv:9092" \
    MESSAGING_SYSTEM="AtlasDeerStage" \
    MESSAGING_ZOOKEEPER="node1.kafka.mbst.tv:2181,node2.kafka.mbst.tv:2181,node3.kafka.mbst.tv:2181" \
    MONGO_READ_HOST="db1.owl.atlas.mbst.tv,db3.owl.atlas.mbst.tv" \
    MONGO_READ_NAME="atlas-split" \
    MONGO_WRITE_HOST="db1.stage.atlas.mbst.tv" \
    MONGO_WRITE_NAME="atlas-split" \
    NOTIFICATIONS_EMAIL_FROM="atlas-admin@metabroadcast.com" \
    NOTIFICATIONS_EMAIL_FROMFRIENDLYNAME="Atlas" \
    NOTIFICATIONS_EMAIL_HOST="smtp.gmail.com" \
    NOTIFICATIONS_EMAIL_PASSWORD="" \
    NOTIFICATIONS_EMAIL_TO="atlas@metabroadcast.com" \
    NOTIFICATIONS_EMAIL_USERNAME="atlas-admin@metabroadcast.com" \
    REPORTING_COLUMBUS-TELESCOPE_HOST="columbus-telescope.mbst.tv" \
    TWITTER_AUTH_CONSUMERKEY="BvVeHDlcMPxyKzGbM6JYw" \
    TWITTER_AUTH_CONSUMERSECRET="" \
    YOUTUBE_CLIENTID="725556533575-rlscsk65f4e8k4quv83fcfckkicbgh4e.apps.googleusercontent.com" \
    YOUTUBE_CLIENTSECRET="" \
    YOUTUBE_HANDLING_SERVICE="http://app1.stage.coyote.mbst.tv" \
    JSSE_ENABLESNIEXTENSION="false" \
    LOG4J_CONFIGURATION="file:////usr/local/jetty/log4j.properties" \
    NIMROD_LOG_LEVEL="INFO" \
    ROOT_LOG_LEVEL="INFO" \
    JVM_MEMORY="5G" \
    JVM_OPTS="-XX:+UseConcMarkSweepGC \
      -XX:+UseParNewGC \
      -XX:CMSInitiatingOccupancyFraction=75 \
      -XX:+ExitOnOutOfMemoryError"

COPY atlas-api/target/atlas-api.war /usr/local/jetty/atlas-api.war
COPY atlas-api/log4j.properties /usr/local/jetty/log4j.properties

WORKDIR /usr/local/jetty

CMD java \
    -Djetty.home="$JETTY_HOME" \
    -Dsun.net.inetaddr.ttl="$SUN_NET_INETADDR_TTL" \
    -DMBST_PLATFORM="$MBST_PLATFORM" \
    -Dcassandra.clientThreads="$CASSANDRA_CLIENTTHREADS" \
    -Dcassandra.cluster="$CASSANDRA_CLUSTER" \
    -Dcassandra.connectionsPerHost.local="$CASSANDRA_CONNECTIONSPERHOST_LOCAL" \
    -Dcassandra.connectionsPerHost.remote="$CASSANDRA_CONNECTIONSPERHOST_REMOTE" \
    -Dcassandra.datastax.timeouts.connections="$CASSANDRA_DATASTAX_TIMEOUTS_CONNECTIONS" \
    -Dcassandra.datastax.timeouts.read="$CASSANDRA_DATASTAX_TIMEOUTS_READ" \
    -Dcassandra.keyspace="$CASSANDRA_KEYSPACE" \
    -Dcassandra.seeds="$CASSANDRA_SEEDS" \
    -Delasticsearch.cluster="$ELASTICSEARCH_CLUSTER" \
    -Delasticsearch.index="$ELASTICSEARCH_INDEX" \
    -Delasticsearch.requestTimeout="$ELASTICSEARCH_REQUESTTIMEOUT" \
    -Delasticsearch.seeds="$ELASTICSEARCH_SEEDS" \
    -Dgithub.auth.consumerKey="$GITHUB_AUTH_CONSUMERKEY" \
    -Dgithub.auth.consumerSecret="$GITHUB_AUTH_CONSUMERSECRET" \
    -Dgoogle.auth.consumerKey="$GOOGLE_AUTH_CONSUMERKEY" \
    -Dgoogle.auth.consumerSecret="$GOOGLE_AUTH_CONSUMERSECRET" \
    -Dmessaging.broker.url="$MESSAGING_BROKER_URL" \
    -Dmessaging.system="$MESSAGING_SYSTEM" \
    -Dmessaging.zookeeper="$MESSAGING_ZOOKEEPER" \
    -Dmongo.read.host="$MONGO_READ_HOST" \
    -Dmongo.read.name="$MONGO_READ_NAME" \
    -Dmongo.write.host="$MONGO_WRITE_HOST" \
    -Dmongo.write.name="$MONGO_WRITE_NAME" \
    -Dnotifications.email.from="$NOTIFICATIONS_EMAIL_FROM" \
    -Dnotifications.email.fromFriendlyName="$NOTIFICATIONS_EMAIL_FROMFRIENDLYNAME" \
    -Dnotifications.email.host="$NOTIFICATIONS_EMAIL_HOST" \
    -Dnotifications.email.password="$NOTIFICATIONS_EMAIL_PASSWORD" \
    -Dnotifications.email.to="$NOTIFICATIONS_EMAIL_TO" \
    -Dnotifications.email.username="$NOTIFICATIONS_EMAIL_USERNAME" \
    -Dreporting.columbus-telescope.host="$REPORTING_COLUMBUS-TELESCOPE_HOST" \
    -Dtwitter.auth.consumerKey="$TWITTER_AUTH_CONSUMERKEY" \
    -Dtwitter.auth.consumerSecret="$TWITTER_AUTH_CONSUMERSECRET" \
    -Dyoutube.clientId="$YOUTUBE_CLIENTID" \
    -Dyoutube.clientSecret="$YOUTUBE_CLIENTSECRET" \
    -Dyoutube.handling.service="$YOUTUBE_HANDLING_SERVICE" \
    -Djsse.enableSNIExtension="$JSSE_ENABLESNIEXTENSION" \
    -Dlog4j.configuration="$LOG4J_CONFIGURATION" \
    -Dnimrod.log.level="$NIMROD_LOG_LEVEL" \
    -Droot.log.level="$ROOT_LOG_LEVEL" \
    -Xmx$JVM_MEMORY \
    -Xms$JVM_MEMORY \
    $JVM_OPTS \
    -jar atlas-api.war
